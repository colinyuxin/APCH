R <- cor(geno_mat, use = "pairwise.complete.obs")
rownames(R) <- colnames(R) <- colnames(geno_mat)
## =============== 7. （可选）与 Bhat / Shat 对齐 ===============
if (exists("Bhat")) {
common <- intersect(rownames(Bhat), rownames(R))
Bhat_ld <- Bhat[common, , drop = FALSE]
Shat_ld <- Shat[common, , drop = FALSE]
R_ld    <- R[common, common, drop = FALSE]
stopifnot(identical(rownames(Bhat_ld), rownames(Shat_ld)))
stopifnot(identical(rownames(Bhat_ld), rownames(R_ld)))
ld_result <- list(
rsid    = common,
Bhat    = Bhat_ld,
Shat    = Shat_ld,
R       = R_ld,
ld_snps = dt_ld[match(common, rsid)]
)
} else {
ld_result <- list(
rsid    = colnames(R),
R       = R,
ld_snps = dt_ld[match(colnames(R), rsid)]
)
}
View(dt_ld)
View(ld_result)
View(ld_result)
ld_result[["ld_snps"]]
ld_result[["R"]]
View(ld_result[["ld_snps"]])
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
## 1) R 的基本性质
max_asym <- max(abs(R - t(R)))
diag_range <- range(diag(R))
min_eig <- min(eigen((R+t(R))/2, symmetric = TRUE, only.values = TRUE)$values)
cat(sprintf("asym=%.2e, diag=[%.3f, %.3f], min_eig=%.3g\n",
max_asym, diag_range[1], diag_range[2], min_eig))
## 2) r^2 与物理距离的负相关（越远相关越小）
pos <- dt_ld$pos38[match(colnames(R), dt_ld$rsid)]
idx <- upper.tri(R)
dist_bp <- abs(outer(pos, pos, "-"))[idx]
r2_vals <- (R[idx])^2
cor_r2_dist <- cor(r2_vals, -log10(dist_bp + 1), use = "complete.obs")
cat(sprintf("cor(r^2, -log10(distance)) = %.3f\n", cor_r2_dist))
## 1) 分箱看平均 r^2 随距离衰减
pos <- dt_ld$pos38[match(colnames(R), dt_ld$rsid)]
idx <- upper.tri(R)
dist_bp <- abs(outer(pos, pos, "-"))[idx]
r2_vals <- (R[idx])^2
breaks <- c(0,5e3,1e4,2.5e4,5e4,1e5,2.5e5,5e5)
labs   <- c("0-5kb","5-10kb","10-25kb","25-50kb","50-100kb","100-250kb","250-500kb")
bin    <- cut(dist_bp, breaks, labels = labs, include.lowest = TRUE, right=TRUE)
tapply(r2_vals, bin, mean, na.rm=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
View(stard10_snps)
View(Bhat_ld)
View(Z)
View(Z)
View(Z)
View(chain_hg19_to_hg38)
View(dt_hg38)
source("~/.active-rstudio-document", echo=TRUE)
View(Z)
View(R_ld)
View(R_ld)
View(Bhat)
View(Bhat_ld)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
View(cs_tbl)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
View(cs_tbl)
source("~/.active-rstudio-document", echo=TRUE)
View(cs_tbl)
idx_snps <- cs_tbl[CS %in% c(1,2,3), index_snp]   # 你要核对的那3个
R_use <- if (exists("R_ld")) R_ld else R
R_idx_r2 <- (R_use[idx_snps, idx_snps, drop=FALSE])^2
pos <- dt_ld$pos38[match(idx_snps, dt_ld$rsid)]
dist_kb <- abs(outer(pos, pos, "-"))/1e3
round(R_idx_r2, 3)   # 三个 index 两两的 r^2
round(dist_kb, 1)    # 距离 (kb)
source("~/APCH/实证代码/mvsusie+apch/1.选取我想看的snp.R", echo=TRUE)
View(stard10_snps)
View(dt_proi)
source("~/APCH/实证代码/mvsusie+apch/1.选取我想看的snp.R", echo=TRUE)
idx_stard10 <- which(dt_proi$rsid == " rs13266634")
dt_proi[idx_stard10]
chr_stard10 <- dt_proi$chromosome[idx_stard10][1]
pos_stard10 <- dt_proi$position[idx_stard10][1]
idx_stard10
source("~/APCH/实证代码/mvsusie+apch/1.选取我想看的snp.R", echo=TRUE)
View(stard10_snps)
source("~/APCH/实证代码/mvsusie+apch/2.算LD.R", echo=TRUE)
source("~/APCH/实证代码/mvsusie+apch/3mvsusie.R", echo=TRUE)
source("~/APCH/实证代码/mvsusie+apch/4locuszoom.R", echo=TRUE)
source("~/APCH/实证代码/mvsusie+apch/4locuszoom.R", echo=TRUE)
source("~/APCH/实证代码/mvsusie+apch/5统计cs.R", echo=TRUE)
source("~/APCH/实证代码/mvsusie+apch/5统计cs.R", echo=TRUE)
View(cs_tbl)
lfsr_mat <- mvsusie_get_lfsr(fit)
View(fit)
## 组件 × 性状 的 lfsr（与 effect_plot 一致）
clfsr <- mvsusie_get_clfsr(fit)      # L × K，行是组件（与 CS 一一对应），列是性状
fit$lfsr
View(fit)
traits    <- colnames(Z)
snp_names <- rownames(Z)
## ---------- 3.1 先看对象的维度 ----------
dim(fit$lfsr)              # 应该是 p × K
dim(fit$conditional_lfsr)  # 应该是 L × p × K
## ---------- 3.2 给 index_snp 填 marginal lfsr ----------
idx_snp <- match(cs_tbl$index_snp, snp_names)
for (k in seq_along(traits)) {
cs_tbl[[paste0("lfsr_", traits[k])]] <-
fit$lfsr[cbind(idx_snp, rep(k, length(idx_snp)))]
}
## ---------- 3.3 给每个 CS 填 component-level conditional lfsr ----------
cs_list  <- fit$sets$cs
# CS ↔ 组件编号的映射（大多数情况下是一一对应）
comp_id <- if (!is.null(fit$sets$cs_index)) fit$sets$cs_index else seq_along(cs_list)
for (k in seq_along(traits)) {
cs_tbl[[paste0("cond_lfsr_", traits[k])]] <-
vapply(seq_along(cs_list), function(j){
comp <- comp_id[j]         # 第 j 个 CS 对应的组件
snp_idx <- idx_snp[j]      # 这个 CS 里你选的 index_snp 的行号
fit$conditional_lfsr[comp, snp_idx, k]
}, numeric(1))
}
## 看结果
cs_tbl[order(CS), ]
View(cs_tbl)
fit$single_effect_lfsr   # 维度 L × K，每个 CS × 每个 trait 的 average-lfsr
View(cs_tbl)
setwd("~/APCH/package_apch")
install.packages("devtools")   # 只需一次
library(devtools)
document()   # or devtools::document()
devtools::document()
devtools::load_all()
source("~/.active-rstudio-document", echo=TRUE)
View(X)
devtools::document()   # 更新 Rd / NAMESPACE
devtools::install()    # 真正安装到你的 R library
source("~/.active-rstudio-document", echo=TRUE)
View(res)
View(res[["infer_res"]][["calls"]])
1+！
1+1
res[["post_mean_called"]]
setwd("~/APCH/package_apch")
devtools::document()   # 重建 Rd、NAMESPACE
devtools::load_all()   # 重新加载当前源码版本
source("~/.active-rstudio-document", echo=TRUE)
View(res)
View(res[["infer_res"]][["calls"]])
View(res)
View(res)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
detach("package:apch", unload = TRUE)
remove.packages("apch")
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
View(res)
View(res)
1+1
## 1. 进到包目录
pkg_dir <- "~/APCH/package_apch"   # <- 这里改成你自己的路径
setwd(pkg_dir)
## 2. 更新 Rcpp 接口（非常重要）
##   - 会重新生成 RcppExports.cpp / RcppExports.R
Rcpp::compileAttributes()
Rcpp::compileAttributes()
1+1
Rcpp::compileAttributes()
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
.Last.error
source("~/.active-rstudio-document", echo=TRUE)
.Last.error
devtools::document()
Rcpp::sourceCpp("src/apch_v12.cpp")
source("~/.active-rstudio-document", echo=TRUE)
Rcpp::sourceCpp("src/apch_v12.cpp")
Rcpp::sourceCpp("src/apch_v12.cpp")
Rcpp::sourceCpp("src/apch_v12.cpp")
source("~/.active-rstudio-document", echo=TRUE)
files <- c(list.files("R", full.names = TRUE), "NAMESPACE", "DESCRIPTION")
for (f in files) {
if (length(grep("fit_all_featutre", readLines(f), fixed = TRUE))) {
cat("Found in:", f, "\n")
}
}
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/APCH/package_apch/R/apch.R", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
View(fit_meta_eb)
View(fit_meta_none)
View(fit_xwas_eb)
fit_xwas_eb[["infer_res"]][["calls"]]
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
View(fit_meta_eb)
View(fit_meta_none)
View(fit_xwas_eb)
View(fit_meta_none)
View(fit_meta_none[["infer_res"]][["calls"]])
View(fit_meta_eb)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
View(meta_none_calls_df)
View(zdf)
View(fit_meta_eb)
fit_meta_eb[["em_res"]][["stageB"]][["delta"]]
View(fit_meta_none)
fit_meta_none[["em_res"]][["stageB"]][["delta"]]
View(meta_none_calls_df)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
View(fit_meta_eb)
View(fit_meta_eb[["infer_res"]][["calls"]])
fit_meta_eb[["em_res"]][["stageB"]][["delta"]]
View(fit_meta_eb)
Rcpp::compileAttributes()   # 生成/更新 RcppExports.cpp 和 RcppExports.R
devtools::clean_dll()
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
useDynLib(apch, .registration = TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/APCH/package_apch/src/apch_posterior.cpp", echo=TRUE)
Rcpp::sourceCpp("src/apch_stageB.cpp")
Rcpp::sourceCpp("src/apch_posterior.cpp")
Rcpp::sourceCpp("src/apch_stageA.cpp")
source("~/.active-rstudio-document", echo=TRUE)
.Last.error
Rcpp::sourceCpp("src/apch_stageA.cpp")
Rcpp::sourceCpp("src/apch_stageB.cpp")
Rcpp::sourceCpp("src/apch_inference.cpp")
Rcpp::sourceCpp("src/apch_posterior.cpp")
source("~/.active-rstudio-document", echo=TRUE)
.Last.error
# 先确认 DESCRIPTION 能正常解析
read.dcf("DESCRIPTION")
# 先清理再生成
unlink(c("src/RcppExports.cpp","R/RcppExports.R"), force=TRUE)
Rcpp::compileAttributes()  # 重新生成 RcppExports.*
# 只编译 src，不装载包，能看全编译/链接报错
pkgbuild::compile_dll(".", debug = TRUE)
# 1) 检查 DCF 是否能正确解析
read.dcf("DESCRIPTION")
# 2) 清理并重生 Rcpp 导出
unlink(c("src/RcppExports.cpp","R/RcppExports.R"), force = TRUE)
Rcpp::compileAttributes()
# 3) 仅编译 C/C++（便于看清楚报错）
pkgbuild::compile_dll(".", debug = TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
View(res_A)
View(res_B)
View(res_C)
View(res_B)
View(res_A)
source("~/.active-rstudio-document", echo=TRUE)
source("~/APCH/实证代码/11月1日/运行apch.R", echo=TRUE)
source("~/APCH/实证代码/11月1日/运行apch.R", echo=TRUE)
source("~/APCH/实证代码/11月1日/运行apch.R", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
View(fit_nopen_mixsqp)
fit_nopen_mixsqp[["em_res"]][["stageB"]][["delta"]]
View(fit_nopen_mixsqp[["infer_res"]][["calls"]])
source("~/.active-rstudio-document", echo=TRUE)
View(fit_nopen_mixsqp)
fit_nopen_mixsqp[["em_res"]][["stageB"]][["delta"]]
View(fit_nopen_mixsqp[["infer_res"]][["calls"]])
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
View(fit_nopen_mixsqp)
fit_nopen_mixsqp[["em_res"]][["stageB"]][["delta"]]
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
View(fit_nopen_mixsqp)
fit_nopen_mixsqp[["em_res"]][["stageB"]][["delta"]]
fit_nopen_mixsqp[["em_res"]][["block_logf"]][[1]]
fit_nopen_mixsqp[["em_res"]][["block_logf"]]
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
View(diff_list)
source("~/.active-rstudio-document", echo=TRUE)
1+1
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
options(repos = c(CRAN = "https://cloud.r-project.org"))
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
View(fit_nopen_mixsqp)
fit_nopen_mixsqp[["config_res"]][["delta"]]
View(fit_nopen_mixsqp[["infer_res"]][["calls"]])
View(fit_nopen_mixsqp)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
View(fit_nopen_mixsqp)
fit_nopen_mixsqp[["config_res"]][["stageB"]][["delta"]]
View(fit_nopen_mixsqp[["infer_res"]][["calls"]])
## ============ 把 calls 和 5 个性状 Z-score 拼成一张大表 ============
calls <- fit_nopen_mixsqp$infer_res$calls
if (!is.null(calls) && nrow(calls) > 0L) {
# 计算 Z 分数矩阵
Zmat <- X / S
colnames(Zmat) <- paste0("z_", colnames(Zmat))  # 列名改成 z_TRAIT
# 把 calls 里的 effect 对应回 X/S 的行
eff_idx <- if ("effect" %in% names(calls)) {
if (is.numeric(calls$effect)) {
as.integer(calls$effect)
} else {
match(calls$effect, rownames(Zmat))
}
} else {
stop("calls 数据框中找不到 'effect' 列，检查 level_by_level_inference 输出。")
}
# 防御性：去掉没匹配上的
ok <- !is.na(eff_idx)
if (!all(ok)) {
warning(sum(!ok), " 个 calls 的 effect 找不到对应的行名，已丢弃。")
}
calls_ok <- calls[ok, , drop = FALSE]
eff_idx_ok <- eff_idx[ok]
z_sub <- Zmat[eff_idx_ok, , drop = FALSE]
# 拼成一个 data.frame
calls_with_z <- cbind(
calls_ok,
as.data.frame(z_sub, check.names = FALSE)
)
View(calls)
1+1
# 计算 Z 分数矩阵
Zmat <- X / S
colnames(Zmat) <- paste0("z_", colnames(Zmat))  # 列名改成 z_TRAIT
# 把 calls 里的 effect 对应回 X/S 的行
eff_idx <- if ("effect" %in% names(calls)) {
if (is.numeric(calls$effect)) {
as.integer(calls$effect)
} else {
match(calls$effect, rownames(Zmat))
}
} else {
stop("calls 数据框中找不到 'effect' 列，检查 level_by_level_inference 输出。")
}
# 防御性：去掉没匹配上的
ok <- !is.na(eff_idx)
if (!all(ok)) {
warning(sum(!ok), " 个 calls 的 effect 找不到对应的行名，已丢弃。")
}
calls_ok <- calls[ok, , drop = FALSE]
eff_idx_ok <- eff_idx[ok]
z_sub <- Zmat[eff_idx_ok, , drop = FALSE]
# 拼成一个 data.frame
calls_with_z <- cbind(
calls_ok,
as.data.frame(z_sub, check.names = FALSE)
)
1+1
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
1+1
1+1
1+1
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
View(calls_with_z)
View(fit_nopen_mixsqp)
fit_nopen_mixsqp[["config_res"]][["stageB"]][["delta"]]
View(calls_with_z)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
View(calls_with_z)
View(fit_nopen_mixsqp)
View(fit_nopen_mixsqp[["infer_res"]][["calls"]])
fit_nopen_mixsqp[["config_res"]][["w_mat"]]
fit_nopen_mixsqp[["config_res"]][["stageB"]][["delta"]]
View(fit_nopen_mixsqp)
Rcpp::sourceCpp("src/apch_stageB.cpp")
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
View(mcmc_res)
mcmc_res[["delta"]]
Rcpp::sourceCpp("src/apch_stageB.cpp")
source("~/.active-rstudio-document", echo=TRUE)
View(mcmc_res)
mcmc_res[["delta"]]
source("~/.active-rstudio-document", echo=TRUE)
View(calls_mcmc)
## 1. 用 MCMC 的 w_mat 做 inference（你刚才已经有 infer_mcmc 了）
# infer_mcmc <- level_by_level_inference(...)
calls_mcmc <- infer_mcmc$calls
## 2. 计算 5 个性状的 z-score
Z <- X[, TRAITS, drop = FALSE] / S[, TRAITS, drop = FALSE]
colnames(Z) <- paste0("z_", TRAITS)   # z_PROIadjBMI, z_FI, ...
## 3. 按“行”匹配：effect == rownames(X / Z)
eff_names <- rownames(Z)
idx <- match(calls_mcmc$effect, eff_names)
# 看一下有没有对不上的
if (any(is.na(idx))) {
warning("有 effect 在 Z 的行名里找不到：",
paste(unique(calls_mcmc$effect[is.na(idx)]), collapse = ", "))
}
z_sub <- Z[idx, , drop = FALSE]
## 4. 拼一张大表（顺便把行号也带上，方便你查原始矩阵）
big_tab_mcmc <- cbind(
calls_mcmc,
row_id = idx,
as.data.frame(z_sub)
)
head(big_tab_mcmc)
dim(big_tab_mcmc)
## 1. 用 MCMC 的 w_mat 做 inference（你已经有 infer_mcmc 了）
calls_mcmc <- infer_mcmc$calls
## 2. 计算 5 个性状的 z-score
Z <- X[, TRAITS, drop = FALSE] / S[, TRAITS, drop = FALSE]
colnames(Z) <- paste0("z_", TRAITS)   # z_PROIadjBMI, z_FI, ...
## 3. 从 effect 里面抠出行号：e115664 -> 115664
eff_chr <- as.character(calls_mcmc$effect)
idx <- as.integer(sub("^[^0-9]*", "", eff_chr))   # 去掉前面的 e，只留数字
# 做一下边界检查
bad <- which(is.na(idx) | idx < 1 | idx > nrow(Z))
if (length(bad) > 0) {
warning("以下 effect 的行号不合法：",
paste(unique(calls_mcmc$effect[bad]), collapse = ", "))
}
z_sub <- Z[idx, , drop = FALSE]
## 4. 拼一张大表（顺便把行号也带上）
big_tab_mcmc <- cbind(
calls_mcmc,
row_id = idx,
as.data.frame(z_sub)
)
head(big_tab_mcmc)
dim(big_tab_mcmc)
View(big_tab_mcmc)
View(big_tab_mcmc)
source("~/.active-rstudio-document", echo=TRUE)
View(big_tab_mcmc)
source("~/.active-rstudio-document", echo=TRUE)
source("~/.active-rstudio-document", echo=TRUE)
View(big_tab_mcmc)
View(calls_mcmc)
View(big_tab_mcmc)
rowname(big_tab_mcmc)
rownames(big_tab_mcmc)
big_tab_mcmc["rs7901695", ]
big_tab_mcmc[" rs2972142", ]
big_tab_mcmc["rs2972142", ]
big_tab_mcmc["rs3892354", ]
big_tab_mcmc[" rs657152", ]
big_tab_mcmc["rs657152", ]
big_tab_mcmc["rs6807089", ]
big_tab_mcmc["rs7756992", ]
View(block_logf)
View(big_tab_mcmc)
View(mcmc_res)
mcmc_res[["w_mat"]]
mcmc_res[["delta"]]
View(calls_mcmc)
Rcpp::sourceCpp("src/apch_stageB_mcmc.cpp")
Rcpp::sourceCpp("src/apch_stageB_mcmc.cpp")
source("~/.active-rstudio-document", echo=TRUE)
matplot(res_mcmc$sweep_index, res_mcmc$phi_trace,
type = "l", lty = 1, xlab = "sweep", ylab = "phi_r")
matplot(mcmc_res$sweep_index, mcmc_res$phi_trace,
type = "l", lty = 1, xlab = "sweep", ylab = "phi_r")
Rcpp::sourceCpp("src/apch_stageB_mcmc.cpp")
source("~/.active-rstudio-document", echo=TRUE)
View(mcmc_res)
mcmc_res[["delta"]]
reticulate::repl_python()
reticulate::repl_python()
reticulate::repl_python()
