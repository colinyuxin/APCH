% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/em_interface.R
\name{apch_em_fit}
\alias{apch_em_fit}
\title{Fit APCH configuration-layer parameters (meta/xwas wrapper)}
\usage{
apch_em_fit(
  X,
  S,
  C,
  grid_list,
  pi_list = NULL,
  configs = NULL,
  mixcompdist = "normal",
  tau_block = 1e-04,
  mode = c("meta", "xwas"),
  max_iter_A = 1e+06,
  tol_A = 1e-06,
  max_iter_B = 1e+06,
  tol_B = 1e-06,
  workers = 8,
  progress_chunk = 128,
  use_parallel = TRUE,
  verbose = TRUE,
  output = c("full", "light"),
  progress = interactive(),
  solver_stageA = c("mixsqp", "em", "loglinear"),
  solver_stageB = c("mcmc", "mixsqp", "em", "loglinear"),
  force_one_block = FALSE,
  stageA_ll_tol = 0.01,
  stageB_ll_tol = 0.01
)
}
\arguments{
\item{X}{Numeric matrix of observed effects (\eqn{n \times p}).}

\item{S}{Numeric matrix of standard errors (same shape as \code{X}).}

\item{C}{Observation-noise structure.
For \code{mode = "meta"}: a numeric \eqn{p \times p} matrix.
For \code{mode = "xwas"}: a list of length \code{n} of \eqn{p \times p} matrices.}

\item{configs}{Binary configuration matrix (\eqn{K \times p}) of all global
activation patterns (strictly MSB-ordered columns).}

\item{mixcompdist}{Slab family (e.g. \code{"normal"}, \code{"uniform"}).}

\item{mode}{Either \code{"meta"} or \code{"xwas"}.}

\item{max_iter_A, tol_A}{Stage-A iteration limit and tolerance for EM/mixsqp.
For \code{"loglinear"} Stage A, \code{tol_A} is ignored and
\code{stageA_ll_tol} is used instead.}

\item{max_iter_B, tol_B}{Stage-B iteration limit and tolerance for EM/mixsqp.
For Stage-B \code{"loglinear"}, \code{tol_B} is ignored and
\code{stageB_ll_tol} is used instead.}

\item{progress_chunk}{Integer chunk size for Stage-A likelihood precomputation.}

\item{use_parallel}{Logical; enable multi-threading in C++ backends.}

\item{verbose}{Logical; print diagnostics. MixSQP output is silenced; we only
print a one-line convergence summary for Stage B.}

\item{output}{Either \code{"full"} (return Stage A/B details) or
\code{"light"} (only \code{w_mat} and \code{delta}).}

\item{progress}{Logical; whether to print Stage-A progress.}

\item{solver_stageA}{Character; Stage-A solver used in the configuration
layer (\code{"mixsqp"}, \code{"em"}, or \code{"loglinear"}).}

\item{solver_stageB}{Character; Stage-B solver (\code{"mcmc"} (default),
\code{"mixsqp"}, \code{"em"}, or \code{"loglinear"}).}

\item{force_one_block}{Logical; when \code{TRUE} in meta-analysis mode,
bypasses block decomposition in Stage A and treats all features as a
single block, but still runs Stage B on the global configurations.
In \code{mode = "xwas"}, a single block和 Stage-B 融合始终使用全局块。}

\item{stageA_ll_tol}{Tolerance for Stage-A \code{"loglinear"} solver
(default \code{0.01}); ignored by other Stage-A solvers.}

\item{stageB_ll_tol}{Tolerance for Stage-B \code{"loglinear"} solver
(default \code{0.01}); ignored by other Stage-B solvers.}
}
\value{
A list mirroring \code{fit_config_meta()} or Stage-A-only solvers,
with rows of \code{w_mat} normalized.
}
\description{
Wrapper around the configuration layer for meta-analysis or xwas modes.
In \code{mode="meta"}, Stage A runs per block (or one block if \code{force_one_block}),
then Stage B fuses blocks using one of \code{solver_stageB}:
\code{"mcmc"}, \code{"mixsqp"}, \code{"em"}, or \code{"loglinear"} (Ising + ridge).
In \code{mode="xwas"}, a single global block is used for Stage A, and Stage B
is applied to the fused global configurations identically.
There is \strong{no} EB/size penalty in Stage B.
}
\details{
Stage A supports \code{"mixsqp"}, \code{"em"}, or \code{"loglinear"}; the
\code{"loglinear"} solver is a softmax + L2 ridge on the pattern weights
(over \eqn{\eta}-patterns in Stage A), controlled by \code{stageA_ll_tol}
(independent of \code{tol_A}). Stage B loglinear uses \code{stageB_ll_tol} as its
convergence tolerance (independent of \code{tol_B}).
}
